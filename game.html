<html>
   <head>
        <!-- JQuery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
        <!-- Bootstrap things -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
		
		<link href="local.css" rel="stylesheet" />
		
      <script type="text/javascript">
	  
		var lastInputs = [false,false,false,false];
		
		var polys = [];
		
		var usersPos = {};
		var upCounter = 0;
		
		var myId = -1;
		var myGroup = "";
		var myX = 0;
		var myY = 0;
		
		var viewX = 0;
		var viewY = 0;
		
		var orntX = 0;
		var orntY = 1;
		
		var mouseX = 0;
		var mouseY = 0;
		
		bg = new Image();
		bg.src = 'TestMap.jpg';
 
		game = null;
		ws = new WebSocket("ws://76.72.20.147:4444");
		
		ws.onopen = function()
               {
                  // Web Socket is connected, send data using send()
                  ws.send("Start;");
				  setTimeout(function(){ 
				  
				  ws.send("Join,Group,GameLogic0/0;");
				  ws.send("Join,Group,ChatServer;")
				  
				  document.addEventListener('keydown', function(event) {
				    var changed = false;
					if(event.keyCode == 87 && lastInputs[0] == false) {
						lastInputs[0] = true;
						changed = true;
					} 
					if(event.keyCode == 65 && lastInputs[1] == false) {
						lastInputs[1] = true;
						changed = true;
					} 
					if(event.keyCode == 83 && lastInputs[2] == false) {
						lastInputs[2] = true;
						changed = true;
					}
					if(event.keyCode == 68 && lastInputs[3] == false) {
						lastInputs[3] = true;
						changed = true;
					}
					if(changed) {
						var x = (lastInputs[3]?1:0) - (lastInputs[1]?1:0);
						var y = (lastInputs[0]?1:0) - (lastInputs[2]?1:0);
						ws.send("Send,"+myGroup+",Movement,"+x+","+y+";");
					}
				   });
				   document.addEventListener('keyup', function(event) {
					var changed = false;
					if(event.keyCode == 87 && lastInputs[0] == true) {
						lastInputs[0] = false;
						changed = true;
					} 
					if(event.keyCode == 65 && lastInputs[1] == true) {
						lastInputs[1] = false;
						changed = true;
					} 
					if(event.keyCode == 83 && lastInputs[2] == true) {
						lastInputs[2] = false;
						changed = true;
					} 
					if(event.keyCode == 68 && lastInputs[3] == true) {
						lastInputs[3] = false;
						changed = true;
					}
					if(changed) {
						var x = (lastInputs[3]?1:0) - (lastInputs[1]?1:0);
						var y = (lastInputs[0]?1:0) - (lastInputs[2]?1:0);
						ws.send("Send,"+myGroup+",Movement,"+x+","+y+";");
					}
				   });
		 game = document.getElementById("game");
		 game.onmousedown = function(event) {
			var x = event.pageX - game.offsetLeft;
			var y = event.pageY - game.offsetTop;
			console.log("Mouse: "+x+","+y+" Canvas: "+game.width+","+game.height);
			if(x < 0.1*game.width) {
				mouseX = -1;
			} else if(x > 0.9*game.width) {
				mouseX = 1;
			}
			if(y < 0.1*game.height) {
				mouseY = 1;
			} else if(y > 0.9*game.height) {
				mouseY = -1;
			}
			ws.send("Send,"+myGroup+",Movement,"+mouseX+","+mouseY+";");
		 }
		 game.onmouseup = function() {
			if(mouseX != 0 || mouseY != 0) {
				mouseX = 0;
				mouseY = 0;
				ws.send("Send,"+myGroup+",Movement,"+mouseX+","+mouseY+";");
			}
		 }
		 game.onmouseout = function() {
			if(mouseX != 0 || mouseY != 0) {
				mouseX = 0;
				mouseY = 0;
				ws.send("Send,"+myGroup+",Movement,"+mouseX+","+mouseY+";");
			}
		 }
				   }, 1000);
				};
				
               ws.onmessage = function (evt) 
               { 
                  var received_msg = evt.data;
				  var res = received_msg.split(";");
				  for (var i = 0; i < res.length; ++i) {
					
					var command = res[i].split(",");
				  
					switch(command[0]) {
						case "UserId":               // instruction format: 'UserId,[id];' ex. 'UserId,0;'
							if (command.length > 1)
							{	
								myId = parseInt(command[1]);
							}
							break;
						case "Global":				//instruction format: 'Global,message;'
							if(command.length > 1)
							{
								var thing = command[1]
								for(var iter = 2; iter < command.length; iter++) {
									thing = thing + "," + command[iter];
									
								}
								$('#chat').val($('#chat').val() + "\n" + thing)
								var t = $('#chat');
								if(t.length){
									t.scrollTop(t[0].scrollHeight - t.height());
								}
							}
						case "ClearUser":               // instruction format: 'UserId,[id];' ex. 'UserId,0;'
							if (command.length > 1)
							{	
								for(var i = 0; i < usersPos.length; ++i) {
									if(command[1] in usersPos) {
										delete usersPos[command[1]];
										i = usersPos.length;
									}
								}
							}
							break;
						case "Update":               // instruction format: 'Update,[id]|[x]|[y],[id2]|[x2]|[y2]...;' ex. 'Update,0|0|0,1|0|1,2|1|0;'
							console.log("Updating...");
							var c = document.getElementById("game");
							var ctx = c.getContext("2d");
							ctx.fillStyle = "#000000";
							ctx.fillRect(0,0,320,240);
							for(var p = 0; p < polys.length; p++) {
								ctx.fillStyle = '#ffffff';
								ctx.beginPath();
								ctx.moveTo(160+polys[p][0][0]-viewX,120-polys[p][0][1]+viewY);
								for(var i = 1; i < polys[p].length; i++) {
									ctx.lineTo(160+polys[p][i][0]-viewX,120-polys[p][i][1]+viewY);
								}
								ctx.closePath();
								ctx.fill();
							}
							//ctx.drawImage(bg, 0, 0);
							
							for (var ui = 1; ui < command.length; ++ui)
							{
								var vals = command[ui].split('|');
	
								if (myId == vals[0])
								{
									myX = parseFloat(vals[1]);
									myY = parseFloat(vals[2]);
									viewX = myX;
									viewY = myY;
								} else {
									var otherX = parseFloat(vals[1]);
									var otherY = parseFloat(vals[2]);
									usersPos[vals[0]] = [otherX,otherY];
								}
							}
							
							for (var p in usersPos) {
								ctx.fillStyle = "#0000FF";
									ctx.beginPath();
									ctx.arc(160+usersPos[p][0]-viewX, 120-usersPos[p][1]+viewY, 4, 0, 2 * Math.PI);
									ctx.fill();
							}
							
							ctx.fillStyle = "#FF0000";
							ctx.beginPath();
							ctx.arc(160+myX-viewX, 120-myY+viewY, 4, 0, 2 * Math.PI);
							ctx.fill();
							break;
						case "Map":
							polys = JSON.parse(command.join().slice(4));
							break;
						case "SetGroup":
							if (command.length > 1)
							{
								myGroup = command[1];
								usersPos = [];
							}
							break;
					}
				  }
               };
			   
			ws.onclose = function() {
							ws.send("Leave,Group,GameLogic;");
							ws.send("Close;");
						};
	  
         function WebSocketTest()
         {
            ws.send("Send");
         }

      </script>
		
   </head>
   <body>
		<div id="site_header" class="row">
			<div class="col-sm-1" style="padding-top: 5px; padding-left: 5px;">
				<span class="fa-stack rotate" style="font-size: 45px;">
					<i class="fa fa-square fa-stack-2x"></i>
					<strong class="fa fa-tree fa-stack-1x animate_color"></strong>
				</span>
			</div>
			<div class="col-sm-3" style="font-size: 40px;line-height: 100px;">
				Dev-Site
			</div>
		</div>
		<div id="site_content">
			<br />
			<canvas id="game" width="320" height="240" style="display:block;margin:auto;">
					Your browser does not support the HTML5 canvas tag.
			</canvas>
			<br />
			<center>
				<textarea id="chat" class="form-control" style="width:50%; max-height:30%; max-width: 50%; height: 200px; overflow-y: scroll;" readonly></textarea> <br />
				<input id="message" class=form-control type="text" style="width:50%;" placeholder="Chat Message" />
				
			</center>
		</div>
   </body>
</html>
<script>
	$(document).ready(function(){
		$("#message").keyup(function(e){
			if(e.keyCode == 13){
				ws.send("Send,ChatServer,Global," + $("#message").val() + ";");
				$('#message').val("");
			}
		});
	
	
	
	
	});
</script>
